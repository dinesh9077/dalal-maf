# name: Deploy to cPanel via SSH

# on:
#   push:
#     branches:
#       - main
#   workflow_dispatch:

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout Repository
#         uses: actions/checkout@v3

#       - name: Setup PHP
#         uses: shivammathur/setup-php@v2
#         with:
#           php-version: '8.1'
#           extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
#           coverage: none

#       - name: Install Composer dependencies
#         run: composer install --no-dev --optimize-autoloader --no-interaction --ignore-platform-reqs

#       - name: Setup SSH Agent
#         uses: webfactory/ssh-agent@v0.5.4
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Upload Files via RSYNC
#         run: |
#           rsync -avz --delete \
#           --exclude='.git' \
#           --exclude='.github' \
#           --exclude='node_modules' \
#           --exclude='tests' \
#           --exclude='.env' \
#           --exclude='.env.example' \
#           --exclude='storage/logs/*' \
#           --exclude='storage/framework/sessions/*' \
#           --exclude='storage/framework/views/*' \
#           --exclude='storage/framework/cache/*' \
#           -e "ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT || 22 }}" \
#           ./ ${{ secrets.CPANEL_USERNAME }}@${{ secrets.CPANEL_HOST }}:${{ secrets.REMOTE_PATH }}

#       - name: Set Correct Permissions
#         run: |
#           ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT || 22 }} \
#           ${{ secrets.CPANEL_USERNAME }}@${{ secrets.CPANEL_HOST }} << 'EOF'
#             cd ${{ secrets.REMOTE_PATH }}
#             chmod -R 755 .
#             chmod -R 775 storage bootstrap/cache
#             find storage -type f -exec chmod 664 {} \;
#             find bootstrap/cache -type f -exec chmod 664 {} \;
#           EOF

#       - name: Run Laravel Optimization Commands
#         run: |
#           ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT || 22 }} \
#           ${{ secrets.CPANEL_USERNAME }}@${{ secrets.CPANEL_HOST }} << 'EOF'
#             cd ${{ secrets.REMOTE_PATH }}
#             php artisan config:cache
#             php artisan route:cache
#             php artisan view:cache
#             php artisan migrate --force
#           EOF

#       - name: Deployment Complete
#         run: |
#           echo "âœ… Deployment completed successfully!"
#           echo "ðŸ“ Files synced to: ${{ secrets.REMOTE_PATH }}"
#           echo "ðŸ”’ Permissions set correctly"
#           echo "âš¡ Laravel caches optimized"
